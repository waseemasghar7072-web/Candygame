<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber-Grid Pro | BZ247 Final Fix</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap');
        :root { --neon: #00ff88; --gold: #ffd700; --bg: #050008; --cyan: #00d4ff; }
        * { user-select: none; -webkit-user-select: none; touch-action: none; -webkit-tap-highlight-color: transparent; }
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Montserrat', sans-serif; color: white; display: flex; flex-direction: column; align-items: center; }

        /* FIXED: Removed side gaps and centered layout */
        .wrapper {
            display: flex; flex-direction: column; align-items: center;
            justify-content: space-between; height: 100dvh; width: 100%;
            padding: 10px 0 25px 0; box-sizing: border-box;
        }

        .hud { width: 95%; display: grid; grid-template-columns: 1fr 0.6fr 0.7fr 1fr; gap: 5px; flex-shrink: 0; }
        .box { background: rgba(30,0,50,0.9); border: 2px solid var(--neon); padding: 5px; border-radius: 10px; text-align: center; }
        .box span { font-size: 7px; color: var(--neon); text-transform: uppercase; display: block; }
        .box b { font-size: 14px; text-shadow: 0 0 10px var(--neon); }
        #nextCanvas { width: 30px; height: 30px; margin-top: 2px; }

        /* FIXED: fit-content ensures no gaps on left/right */
        #container { 
            position: relative; border: 3px solid #444; background: #000; 
            box-shadow: 0 0 30px rgba(0,255,136,0.15); flex-grow: 1;
            display: flex; align-items: center; justify-content: center; 
            margin: 10px 0; width: fit-content; /* Hugs the canvas width */
        }
        canvas { max-height: 100%; display: block; }

        .controls { width: 95%; max-width: 400px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; flex-shrink: 0; }
        .btn { 
            background: rgba(0,255,136,0.1); border: 2px solid var(--neon); color: var(--neon); 
            padding: 18px 0; border-radius: 15px; font-weight: 900; text-align: center; 
            font-size: 12px; cursor: pointer;
        }
        .rotate { border-color: var(--gold); color: var(--gold); }
        .drop { grid-column: span 3; background: var(--cyan); color: #000; border: none; padding: 16px; margin-top: 5px; box-shadow: 0 0 20px var(--cyan); }
        .btn:active { transform: scale(0.92); filter: brightness(1.3); }

        /* SOUND OVERLAY */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .start-btn { background: var(--neon); color: black; padding: 20px 40px; border-radius: 50px; font-weight: 900; font-size: 18px; cursor: pointer; border: none; box-shadow: 0 0 30px var(--neon); }

        .shake { animation: shake 0.2s both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } }
    </style>
</head>
<body>

    <div id="overlay">
        <button class="start-btn" onclick="startWithSound()">START MISSION ▶</button>
    </div>

    <div class="wrapper">
        <div class="hud">
            <div class="box"><span>Points</span><b id="sTxt">0</b></div>
            <div class="box" style="border-color:var(--gold);"><span>Level</span><b id="lTxt" style="color:var(--gold);">1</b></div>
            <div class="box" style="border-color:var(--gold);"><span>Next</span><center><canvas id="nextCanvas"></canvas></center></div>
            <div class="box"><span>High</span><b id="bTxt">0</b></div>
        </div>

        <div id="container"><canvas id="tetris"></canvas></div>

        <div class="controls">
            <div class="btn" onclick="moveLeft()">LEFT</div>
            <div class="btn rotate" onclick="playerRotate()">ANGLE</div>
            <div class="btn" onclick="moveRight()">RIGHT</div>
            <div class="btn drop" onclick="playerDrop()">NEON DROP ▼ (FAST)</div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('tetris'), ctx = canvas.getContext('2d');
    const nextCanvas = document.getElementById('nextCanvas'), nCtx = nextCanvas.getContext('2d');
    const ROW = 20, COL = 10, SQ = 30;

    let audioCtx, gameActive = false, score = 0, level = 1, best = localStorage.getItem('bzBest')||0;
    let board = [], nextPieceObj, dropStart;

    function initAudio() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(f, type, d) {
        if(!audioCtx) return;
        let o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(0.08, audioCtx.currentTime); // Increased gain
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    function vib(ms) { if(navigator.vibrate) navigator.vibrate(ms); }

    function startWithSound() {
        document.getElementById('overlay').style.display = 'none';
        initAudio();
        startGame();
        playSound(440, 'sine', 0.2); // Welcome beep
    }

    function drawSquare(x, y, color, context, size = SQ) {
        if(color === "black") return;
        context.shadowBlur = 10; context.shadowColor = color;
        context.strokeStyle = color; context.lineWidth = 2;
        context.strokeRect(x * size + 2, y * size + 2, size - 4, size - 4);
        context.globalAlpha = 0.2; context.fillStyle = color;
        context.fillRect(x * size + 4, y * size + 4, size - 8, size - 8);
        context.globalAlpha = 1.0; context.shadowBlur = 0;
    }

    const PIECES = [
        [[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]], "#00d4ff"],
        [[[1,0,0],[1,1,1],[0,0,0]], "#0044ff"],
        [[[0,0,1],[1,1,1],[0,0,0]], "#ff8800"],
        [[[1,1],[1,1]], "#ffd700"],
        [[[0,1,1],[1,1,0],[0,0,0]], "#00ff88"],
        [[[0,1,0],[1,1,1],[0,0,0]], "#cc00ff"],
        [[[1,1,0],[0,1,1],[0,0,0]], "#ff0055"]
    ];

    class Piece {
        constructor(pattern, color) { this.active = pattern; this.color = color; this.x = 3; this.y = -2; }
        collision(x,y,piece) {
            for(let r=0; r<piece.length; r++){ for(let c=0; c<piece.length; c++){
                if(!piece[r][c]) continue;
                let newX = this.x+c+x, newY = this.y+r+y;
                if(newX<0 || newX>=COL || newY>=ROW) return true;
                if(newY>=0 && board[newY][newX] !== "black") return true;
            }} return false;
        }
        lock() {
            for(let r=0; r<this.active.length; r++){
                for(let c=0; c<this.active.length; c++){
                    if(!this.active[r][c]) continue;
                    if(this.y+r < 0){ gameActive=false; location.reload(); return; }
                    board[this.y+r][this.x+c] = this.color;
                }
            }
            let lns = 0;
            for(let r = ROW - 1; r >= 0; r--){
                let f = true; for(let c = 0; c < COL; c++) if(board[r][c] === "black"){ f = false; break; }
                if(f){ board.splice(r, 1); board.unshift(new Array(COL).fill("black")); lns++; r++; }
            }
            if(lns > 0){
                score += (lns * 100) * level;
                if(score >= level * 1000) { level++; playSound(600, 'sine', 0.2); }
                document.getElementById('sTxt').innerText = score;
                document.getElementById('lTxt').innerText = level;
                if(score > best) { best = score; localStorage.setItem('bzBest', best); document.getElementById('bTxt').innerText = best; }
                playSound(400, 'square', 0.1); vib([40, 30, 40]);
                document.getElementById('container').classList.add('shake');
                setTimeout(()=>document.getElementById('container').classList.remove('shake'), 150);
            }
        }
    }

    function drawNext() {
        nCtx.clearRect(0,0,nextCanvas.width,nextCanvas.height);
        const s = 8;
        for(let r=0; r<nextPieceObj.active.length; r++)
            for(let c=0; c<nextPieceObj.active.length; c++)
                if(nextPieceObj.active[r][c]) drawSquare(c, r, nextPieceObj.color, nCtx, s);
    }

    function getPiece() { let r = Math.floor(Math.random()*PIECES.length); return new Piece(PIECES[r][0], PIECES[r][1]); }

    let p;
    function loop() {
        if(!gameActive) return;
        let speed = Math.max(100, 800 - (level * 60));
        if(Date.now() - dropStart > speed) {
            if(!p.collision(0,1,p.active)) p.y++;
            else { p.lock(); p = nextPieceObj; nextPieceObj = getPiece(); drawNext(); }
            dropStart = Date.now();
        }
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(let r=0; r<ROW; r++) for(let c=0; c<COL; c++) drawSquare(c,r,board[r][c], ctx);
        for(let r=0; r<p.active.length; r++) for(let c=0; c<p.active.length; c++) if(p.active[r][c]) drawSquare(p.x+c, p.y+r, p.color, ctx);
        requestAnimationFrame(loop);
    }

    function startGame() {
        canvas.width = COL*SQ; canvas.height = ROW*SQ; nextCanvas.width = 32; nextCanvas.height = 32;
        board = []; for(let r=0; r<ROW; r++){ board[r]=[]; for(let c=0; c<COL; c++){ board[r][c]="black"; }}
        document.getElementById('bTxt').innerText = best;
        p = getPiece(); nextPieceObj = getPiece(); drawNext();
        gameActive = true; dropStart = Date.now(); loop();
    }

    function moveLeft() { if(!p.collision(-1,0,p.active)) { p.x--; vib(15); playSound(200, 'sine', 0.05); } }
    function moveRight() { if(!p.collision(1,0,p.active)) { p.x++; vib(15); playSound(200, 'sine', 0.05); } }
    function playerRotate() { 
        let next = [];
        for(let r=0; r<p.active.length; r++){ next[r]=[]; for(let c=0; c<p.active.length; c++) next[r][c]=p.active[p.active.length-1-c][r]; }
        if(!p.collision(0,0,next)){ p.active = next; vib(15); playSound(300, 'sine', 0.05); }
    }
    function playerDrop() {
        while(!p.collision(0, 1, p.active)) p.y++;
        p.lock(); p = nextPieceObj; nextPieceObj = getPiece(); drawNext();
        dropStart = Date.now(); vib(35); playSound(150, 'sine', 0.1);
    }
</script>
</body>
</html>
