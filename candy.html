<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Candy Mafia: Grand Heist 3D</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Bebas+Neue&display=swap');
        
        :root { --gold: #FFD700; --neon-blue: #00FFFF; --neon-pink: #FF00FF; --ui-bg: rgba(10, 20, 40, 0.9); }

        body { 
            margin: 0; padding: 0; font-family: 'Orbitron', sans-serif; 
            background: url('https://img.freepik.com/free-photo/treasure-cave-full-gold-coins-gems-generated-by-ai_188544-23577.jpg') no-repeat center center fixed;
            background-size: cover; color: white; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; touch-action: none;
        }

        /* Top Bar - Image 3 Style */
        .top-ui { width: 95%; max-width: 450px; display: flex; justify-content: space-between; margin-top: 15px; z-index: 10; }
        .ui-box { background: var(--ui-bg); border: 2px solid #4a90e2; border-radius: 12px; padding: 8px 15px; text-align: center; box-shadow: 0 0 15px rgba(0,0,0,0.5); width: 80px; }
        .ui-box span { font-size: 10px; color: #aaa; text-transform: uppercase; display: block; margin-bottom: 2px;}
        .ui-box b { font-size: 18px; color: white; text-shadow: 0 0 8px var(--neon-blue); }
        
        .stage-box { background: linear-gradient(to bottom, #4a90e2, #2c3e50); border: 2px solid #fff; padding: 5px 30px; border-radius: 10px; font-family: 'Bebas Neue'; font-size: 28px; letter-spacing: 2px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }

        .progress-bar { width: 90%; max-width: 400px; height: 12px; background: rgba(0,0,0,0.6); border-radius: 20px; margin: 15px 0; border: 1px solid #fff; overflow: hidden; }
        #fill { width: 0%; height: 100%; background: linear-gradient(to right, #00f2ff, #ff00ea); transition: 0.4s; }

        /* Grid - Circuit Effect */
        .board-wrapper { position: relative; padding: 8px; background: rgba(0,0,0,0.5); border-radius: 15px; border: 3px solid #5a6fa1; box-shadow: 0 0 30px rgba(0,0,0,0.8); background-image: radial-gradient(circle, #2a3a5a 1px, transparent 1px); background-size: 20px 20px; }
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; width: 92vw; max-width: 380px; height: 92vw; max-height: 380px; }
        .slot { background: rgba(255,255,255,0.05); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); position: relative; }

        .item { width: 90%; height: 90%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .item img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.6)); }

        .footer-ui { background: var(--ui-bg); border: 2px solid #4a90e2; margin-top: 20px; padding: 10px 40px; border-radius: 15px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .footer-ui span { font-size: 12px; color: var(--neon-blue); font-weight: bold; letter-spacing: 1px; }
        .footer-ui b { font-size: 32px; display: block; font-family: 'Bebas Neue'; letter-spacing: 3px; }

        /* Win Overlay with Chest */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .win-card { border: 3px solid var(--gold); background: #111; padding: 30px; border-radius: 20px; text-align: center; }
        .chest-img { width: 150px; margin-bottom: 20px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }
        .btn { background: var(--gold); border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; margin-top: 20px; cursor: pointer; font-family: 'Orbitron'; box-shadow: 0 5px 15px rgba(255,215,0,0.4); }

        .mute-btn { position: fixed; bottom: 15px; right: 15px; border:none; background:var(--gold); border-radius:50%; width:50px; height:50px; font-size:20px; z-index: 200; }
    </style>
</head>
<body>

    <div class="top-ui">
        <div class="ui-box"><span>Target</span><b id="target">500</b></div>
        <div class="stage-box">STAGE <span id="lvl">1</span></div>
        <div class="ui-box"><span>Moves</span><b id="moves">15</b></div>
    </div>

    <div class="progress-bar"><div id="fill"></div></div>

    <div class="board-wrapper"><div class="grid" id="grid"></div></div>

    <div class="footer-ui"><span>CURRENT LOOT</span><b id="coins">0</b></div>

    <button class="mute-btn" onclick="toggleMusic()">ðŸŽµ</button>

    <div id="winScreen" class="overlay">
        <div class="win-card">
            <img src="https://cdn-icons-png.flaticon.com/512/3554/3554562.png" class="chest-img" alt="Chest">
            <h1 style="color:var(--gold); margin:0;">MISSION COMPLETE!</h1>
            <p id="rank">RANK: STREET THUG</p>
            <button class="btn" onclick="nextLevel()">COLLECT LOOT</button>
        </div>
    </div>

<script>
    const gridEl = document.getElementById('grid'), coinsEl = document.getElementById('coins'), movesEl = document.getElementById('moves');
    const assets = [
        'https://cdn-icons-png.flaticon.com/512/3258/3258522.png', // Diamond
        'https://cdn-icons-png.flaticon.com/512/2953/2953363.png', // Gold Bag
        'https://cdn-icons-png.flaticon.com/512/2311/2311893.png', // Cash
        'https://cdn-icons-png.flaticon.com/512/744/744465.png',   // Car
        'https://cdn-icons-png.flaticon.com/512/2883/2883492.png', // Gun
        'https://cdn-icons-png.flaticon.com/512/5218/5218552.png'  // Coin
    ];

    const bgMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3');
    const matchSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3');
    bgMusic.loop = true; bgMusic.volume = 0.3;

    let squares = [], moves = 15, coins = 0, currentLvl = 0, isProcessing = false, sX, sY;
    const stages = [
        { t: 500, m: 15, r: "STREET THUG" },
        { t: 1500, m: 20, r: "MUSCLE" },
        { t: 3500, m: 20, r: "HITMAN" },
        { t: 6000, m: 22, r: "ENFORCER" },
        { t: 10000, m: 25, r: "MAFIA BOSS" }
    ];

    function toggleMusic() {
        if(bgMusic.paused) bgMusic.play();
        else bgMusic.pause();
    }

    function init() {
        gridEl.innerHTML = ''; squares = [];
        const config = stages[currentLvl];
        moves = config.m; coins = 0; isProcessing = false;
        movesEl.innerText = moves; coinsEl.innerText = coins;
        document.getElementById('target').innerText = config.t;
        document.getElementById('lvl').innerText = currentLvl + 1;
        document.getElementById('fill').style.width = '0%';

        for (let i = 0; i < 64; i++) {
            const slot = document.createElement('div'); slot.className = 'slot';
            const item = document.createElement('div'); item.className = 'item';
            const img = document.createElement('img');
            img.src = assets[Math.floor(Math.random()*assets.length)];
            
            item.appendChild(img);
            item.ontouchstart = (e) => { 
                sX = e.touches[0].clientX; sY = e.touches[0].clientY;
                if(bgMusic.paused) bgMusic.play().catch(()=>{}); 
            };
            item.ontouchend = (e) => { 
                if(isProcessing || moves <= 0) return;
                let dX = e.changedTouches[0].clientX - sX, dY = e.changedTouches[0].clientY - sY;
                if(Math.abs(dX) > 20 || Math.abs(dY) > 20) {
                    let dir = Math.abs(dX) > Math.abs(dY) ? (dX > 0 ? 1 : -1) : (dY > 0 ? 8 : -8);
                    handleMove(i, i + dir);
                }
            };
            slot.appendChild(item); gridEl.appendChild(slot); squares.push(img);
        }
        setTimeout(checkMatches, 500);
    }

    async function handleMove(id1, id2) {
        if (id2 < 0 || id2 >= 64 || (Math.abs(id1-id2)===1 && Math.floor(id1/8)!==Math.floor(id2/8))) return;
        isProcessing = true;
        let t = squares[id1].src;
        squares[id1].src = squares[id2].src; squares[id2].src = t;
        await new Promise(r => setTimeout(r, 300));

        if(!checkMatches()) {
            squares[id2].src = squares[id1].src; squares[id1].src = t;
            isProcessing = false;
        } else {
            moves--; movesEl.innerText = moves;
            matchSound.currentTime = 0; matchSound.play();
        }
    }

    function checkMatches() {
        let matches = new Set();
        for(let r=0; r<8; r++) { for(let c=0; c<6; c++) { let i=r*8+c; if(squares[i].src === squares[i+1].src && squares[i].src === squares[i+2].src) { matches.add(i); matches.add(i+1); matches.add(i+2); }}}
        for(let c=0; c<8; c++) { for(let r=0; r<6; r++) { let i=r*8+c; if(squares[i].src === squares[i+8].src && squares[i].src === squares[i+16].src) { matches.add(i); matches.add(i+8); matches.add(i+16); }}}

        if(matches.size > 0) {
            matches.forEach(id => squares[id].style.transform = 'scale(0)');
            coins += matches.size * 10; coinsEl.innerText = coins;
            document.getElementById('fill').style.width = Math.min((coins/stages[currentLvl].t)*100, 100) + '%';
            setTimeout(fill, 400); 
            if(coins >= stages[currentLvl].t) triggerWin();
            return true;
        }
        isProcessing = false; return false;
    }

    function fill() {
        for (let i = 0; i < 64; i++) {
            if (squares[i].style.transform === 'scale(0)') {
                squares[i].src = assets[Math.floor(Math.random()*assets.length)];
                squares[i].style.transform = 'scale(1)';
            }
        }
        setTimeout(checkMatches, 500);
    }

    function triggerWin() {
        document.getElementById('rank').innerText = "RANK: " + stages[currentLvl].r;
        document.getElementById('winScreen').style.display = 'flex';
    }

    function nextLevel() {
        currentLvl++; document.getElementById('winScreen').style.display = 'none'; init();
    }

    window.onload = init;
</script>
</body>
</html>
