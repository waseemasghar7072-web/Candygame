<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Candy Soda Ultra - Power Fix</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
        :root { --p-blue: #00c6ff; --p-green: #00e676; --pink: #ff4081; --gold: #ffd700; }
        body { margin: 0; padding: 0; font-family: 'Fredoka One', cursive; background: linear-gradient(#00c6ff, #0072ff); min-height: 100vh; display: flex; flex-direction: column; align-items: center; color: white; overflow: hidden; touch-action: none; }
        
        /* Header */
        .header { width: 100%; padding: 10px 0; background: linear-gradient(var(--p-green), #00b248); display: flex; justify-content: space-around; align-items: center; border-bottom: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 10; }
        .stat { background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
        
        /* Board */
        .board-bg { background: rgba(255,255,255,0.2); padding: 8px; border-radius: 20px; margin: 20px auto; border: 3px solid white; box-shadow: 0 10px 25px rgba(0,0,0,0.2); backdrop-filter: blur(5px); }
        .grid { display: grid; grid-template-columns: repeat(8, 42px); gap: 4px; }
        .slot { width: 42px; height: 42px; background: rgba(0,0,0,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; }
        
        /* Candies & Powers */
        .fruit { font-size: 32px; cursor: pointer; position: absolute; transition: transform 0.2s; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.4)); }
        .selected { transform: scale(1.3); filter: brightness(1.3); z-index: 10; }
        
        /* Power-Up Look */
        .power-rocket { background: rgba(255, 255, 255, 0.4); border-radius: 50%; box-shadow: 0 0 15px #fff; animation: glow 0.8s infinite alternate; }
        .power-bomb { background: rgba(255, 64, 129, 0.4); border-radius: 50%; box-shadow: 0 0 20px var(--pink); animation: pulse 0.5s infinite alternate; }
        
        @keyframes glow { from {box-shadow: 0 0 5px #fff;} to {box-shadow: 0 0 20px #fff;} }
        @keyframes pulse { from {transform: scale(1);} to {transform: scale(1.15);} }
        @keyframes shake { 0%, 100% {transform: translate(0,0);} 25% {transform: translate(-5px,0);} 75% {transform: translate(5px,0);} }
        .shake { animation: shake 0.3s; }
        .pop { animation: pop 0.4s forwards; }
        @keyframes pop { 0% {transform: scale(1);} 100% {transform: scale(0); opacity: 0;} }

        /* Shop & Overlays */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn { padding: 12px 30px; background: var(--p-green); border: none; border-radius: 25px; color: white; font-size: 20px; font-family: 'Fredoka One'; cursor: pointer; }
    </style>
</head>
<body>
    <div id="winScreen" class="overlay">
        <h1 style="color: var(--gold);">STAGE COMPLETE! üåü</h1>
        <p>You earned üí∞ 50 Coins</p>
        <button class="btn" onclick="nextStage()">NEXT LEVEL ‚ñ∂</button>
    </div>

    <div class="header">
        <div class="stat">Coins<br><b id="coins" style="color:var(--gold);">0</b></div>
        <div class="stat">Score<br><b id="score">0</b></div>
        <div class="stat">Stage<br><b id="stage">1</b></div>
        <div class="stat" style="background:var(--pink);">Moves<br><b id="moves">30</b></div>
    </div>
    
    <div style="margin-top: 15px;">Target: <span id="targetCount">15</span> <span id="targetIcon">üçé</span></div>
    
    <div class="board-bg" id="board"><div class="grid" id="grid"></div></div>

<script>
    const gridEl = document.getElementById('grid'), scoreEl = document.getElementById('score'), movesEl = document.getElementById('moves');
    const targetCountEl = document.getElementById('targetCount'), coinEl = document.getElementById('coins'), boardEl = document.getElementById('board');
    const fruits = ['üçé', 'üçä', 'üçã', 'üçá', 'ü´ê', 'ü••'];
    let stage = 1, targetAmount = 15, score = 0, moves = 30, coins = parseInt(localStorage.getItem('candyCoins'))||0;
    let squares = [], firstId = null, isProcessing = false;

    function init() {
        gridEl.innerHTML = ''; squares = []; coinEl.innerText = coins;
        for (let i = 0; i < 64; i++) {
            const slot = document.createElement('div'); slot.className = 'slot';
            const f = document.createElement('div'); f.className = 'fruit';
            f.innerHTML = fruits[Math.floor(Math.random()*6)];
            f.dataset.type = "normal"; f.onclick = () => tap(i);
            slot.appendChild(f); gridEl.appendChild(slot); squares.push(f);
        }
        setTimeout(() => check(null), 500);
    }

    function tap(id) {
        if(isProcessing || moves <= 0) return;
        if(firstId === null) { firstId = id; squares[id].classList.add('selected'); }
        else { swap(firstId, id); firstId = null; }
    }

    function swap(id1, id2) {
        if(Math.abs(Math.floor(id1/8)-Math.floor(id2/8)) + Math.abs(id1%8-id2%8) !== 1) {
            squares[id1].classList.remove('selected'); return;
        }
        isProcessing = true;
        let f1 = squares[id1], f2 = squares[id2];
        let t = f1.innerHTML, ty = f1.dataset.type, cl = f1.className;
        f1.innerHTML = f2.innerHTML; f1.dataset.type = f2.dataset.type; f1.className = f2.className;
        f2.innerHTML = t; f2.dataset.type = ty; f2.className = cl;
        f1.classList.remove('selected');

        if(!check(id2)) {
            setTimeout(() => { // Revert
                let t = f1.innerHTML; f1.innerHTML = f2.innerHTML; f2.innerHTML = t;
                isProcessing = false;
            }, 300);
        } else {
            moves--; movesEl.innerText = moves; isProcessing = false;
        }
    }

    function check(lastId) {
        let matches = new Set();
        // Row check
        for(let r=0; r<8; r++) {
            for(let c=0; c<6; c++) {
                let i = r*8+c;
                if(squares[i].innerHTML === squares[i+1].innerHTML && squares[i].innerHTML === squares[i+2].innerHTML) {
                    matches.add(i); matches.add(i+1); matches.add(i+2);
                }
            }
        }
        // Col check
        for(let c=0; c<8; c++) {
            for(let r=0; r<6; r++) {
                let i = r*8+c;
                if(squares[i].innerHTML === squares[i+8].innerHTML && squares[i].innerHTML === squares[i+16].innerHTML) {
                    matches.add(i); matches.add(i+8); matches.add(i+16);
                }
            }
        }

        if(matches.size > 0) {
            // Power-up Logic
            if(lastId !== null && matches.has(lastId)) {
                if(matches.size === 4) { 
                    squares[lastId].dataset.type = "rocket"; 
                    squares[lastId].classList.add("power-rocket");
                    squares[lastId].innerHTML = "üöÄ";
                } else if(matches.size >= 5) {
                    squares[lastId].dataset.type = "bomb";
                    squares[lastId].classList.add("power-bomb");
                    squares[lastId].innerHTML = "üí£";
                }
            }

            matches.forEach(id => {
                if(squares[id].dataset.type === "rocket") { clearRow(Math.floor(id/8)); }
                if(squares[id].dataset.type === "bomb") { clearArea(id); }
                if(squares[id].innerHTML === "üçé" && targetAmount > 0) { targetAmount--; targetCountEl.innerText = targetAmount; }
                squares[id].classList.add('pop');
            });

            score += matches.size * 10; scoreEl.innerText = score;
            if(targetAmount <= 0) { win(); return true; }
            setTimeout(fill, 400); return true;
        }
        return false;
    }

    function clearRow(row) {
        boardEl.classList.add('shake'); setTimeout(()=>boardEl.classList.remove('shake'), 300);
        for(let i=row*8; i<(row*8)+8; i++) squares[i].classList.add('pop');
    }

    function clearArea(id) {
        boardEl.classList.add('shake');
        let area = [id-1, id+1, id-8, id+8, id-9, id-7, id+9, id+7];
        area.forEach(i => { if(i>=0 && i<64) squares[i].classList.add('pop'); });
    }

    function fill() {
        squares.forEach(s => { if(s.classList.contains('pop')) { s.innerHTML = fruits[Math.floor(Math.random()*6)]; s.dataset.type="normal"; s.className="fruit"; } });
        check(null);
    }

    function win() {
        coins += 50; localStorage.setItem('candyCoins', coins);
        document.getElementById('winScreen').style.display = 'flex';
    }

    function nextStage() {
        stage++; targetAmount = 15 + (stage*5);
        document.getElementById('stage').innerText = stage;
        targetCountEl.innerText = targetAmount;
        moves = 30; movesEl.innerText = moves;
        document.getElementById('winScreen').style.display = 'none';
        init();
    }

    window.onload = init;
</script>
</body>
</html>
